---
title: "Mixed Effect Modeling"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
library(dplyr)
library(lmerTest)
library(pander)
library(broom)
library(kableExtra)
```

# Load Data
```{r}
# Regular data
homelessness_data = read.csv('../data/processed/pivoted_and_PIT.csv')

#Standardized Data
standardize = function(col){
  col = (col - mean(col)) / sd(col)
  return(col)
}

homelessness_data_standard = homelessness_data |>
  mutate(across(where(is.numeric) & !all_of("Unsheltered.Per.100.000"), standardize))
```

# Implement Models
```{r}
ignored_features = c("PEH.Per.100.000", "Total.PEH", "Unsheltered.PEH", "Population")


model <- lmer(Unsheltered.Per.100.000 ~ 
              bridge.to.housing.network + emergency.shelter + family.reunification.program + 
              flexible.funds + food.and.nutrition + homeless.services + homelessness.prevention + 
              homeshare.program + housing.assistance + housing.navigation.services + 
              housing.stability.services + motel.voucher + neighborhood.revitalization.services + 
              opening.doors.program + outreach + project.h.o.p.e. + rapid.re.housing + 
              rental.assistance + restrooms + safe.parking + service.center + staff.and.operations + 
              take.back.the.streets + transitional.housing + work.for.hope + 
              (1 + Year | City), data = homelessness_data |> select(-all_of(ignored_features)))

modelS <- lmer(Unsheltered.Per.100.000 ~ 
              bridge.to.housing.network + emergency.shelter + family.reunification.program + 
              flexible.funds + food.and.nutrition + homeless.services + homelessness.prevention + 
              homeshare.program + housing.assistance + housing.navigation.services + 
              housing.stability.services + motel.voucher + neighborhood.revitalization.services + 
              opening.doors.program + outreach + project.h.o.p.e. + rapid.re.housing + 
              rental.assistance + restrooms + safe.parking + service.center + staff.and.operations + 
              take.back.the.streets + transitional.housing + work.for.hope + 
              (1 + Year | City), data = homelessness_data_standard |> select(-all_of(ignored_features)))
```
# Model Summaries
```{r}
summarize_model <- function(model) {
  # Extract the full model summary
  model_summary <- summary(model)
  
  # Convert the fixed effects table to a data frame
  fixed_effects <- as.data.frame(model_summary$coefficients)
  
  # Sort the fixed effects by Estimate
  sorted_fixed_effects <- fixed_effects[order(fixed_effects$Estimate), ]
  
  # Add the C-like format for estimates, but remove the predictor names in the formatted column
  sorted_fixed_effects$Estimates <- sprintf("%.4f", sorted_fixed_effects$Estimate)
  
  # Remove the original 'Estimate' column
  sorted_fixed_effects <- sorted_fixed_effects[, !names(sorted_fixed_effects) %in% c("Estimate")]
  
  # Rearrange the columns to move 'Estimates' to the front
  sorted_fixed_effects <- sorted_fixed_effects[, c("Estimates", setdiff(names(sorted_fixed_effects), "Estimates"))]
  
  # Print the modified summary with formatted estimates
  sorted_fixed_effects %>%
    kable("latex", booktabs = TRUE) %>%
    kable_styling(latex_options = "scale_down")
}

summarize_model(model)
summarize_model(modelS)
```
# Plot Estimates
```{r}
# Extract fixed effects
fixed_effects <- as.data.frame(summary(modelS)$coefficients)

# Remove the intercept row
fixed_effects_no_intercept <- fixed_effects[rownames(fixed_effects) != "(Intercept)", ]

# Reorder the predictors based on the Estimate
fixed_effects_no_intercept$Predictor <- factor(
  rownames(fixed_effects_no_intercept),
  levels = rownames(fixed_effects_no_intercept)[order(fixed_effects_no_intercept$Estimate)]
)

# Plot the fixed effects excluding the intercept, sorted by Estimate
ggplot(fixed_effects_no_intercept, aes(x = Predictor, y = Estimate)) +
  geom_bar(stat = "identity") +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10), # Rotate and adjust the labels
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12)
  ) +
  labs(
    title = "Fixed Effects Coefficients",
    x = "Predictors",
    y = "Estimate"
  )
```
# Assessing Residuals and Model Fit
```{r}
# Plot residuals
plot(resid(model))
qqnorm(resid(model))
qqline(resid(model))
```


